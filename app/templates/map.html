{% extends "base.html" %}
{% block content %}
<style>
    /* Legend Styles*/
    .legend_title {
        font-weight: bold;
        font-size: 1.2rem;
    }

    /* Modal Styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1050; /* Sit on top */
        padding-top: 10%;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5); /* Black with opacity */
    }
    .modal-content {
        margin: auto;
        padding: 20px;
        background: #fff;
        border-radius: 5px;
        width: 80%;
        box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
        font-size: 1.5rem;
        margin-bottom: 15px;
    }
    .modal-close {
        float: right;
        font-size: 1.5rem;
        cursor: pointer;
    }

    #controls {
        display: flex;
        justify-content: space-between;
        width: 90%; /* Match the map width */
        margin: 10px auto; /* Center horizontally */
    }
    #legend, #filters {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.1);
    }
    #legend {
        margin-right: 10px;
    }
    #legend ul, #filters ul {
        list-style-type: none;
        padding: 0;
    }
    #legend li {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    #legend .color-box {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border: 1px solid #ccc;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    // Define initMap globally for Google Maps API callback
    window.initMap = function () {
        const map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 46.93344282067525, lng: 8.22573253428211 },
            zoom: 9,
        });

        const shapes = []; // Store all shapes for filtering

        // Fetch river/lake data from Flask backend
        $.getJSON("/get_coords", function (data) {
            data.forEach((feature) => {
                // Determine river color
                let riverColor = "#006782"; // Default private
                if (parseInt(feature.public) === 1) riverColor = "#0ca4cc"; // Public
                if (parseInt(feature.schongebiet) === 1) riverColor = "#94062c"; // Schongebiet

                const shape = new google.maps.Polyline({
                    path: feature.coordinates,
                    geodesic: true,
                    strokeColor: riverColor,
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    map: map,
                });

                shapes.push({ shape, public: feature.public, schongebiet: feature.schongebiet });

                google.maps.event.addListener(shape, "click", function () {
                    document.getElementById("modalTitle").innerText = feature.name;
                    document.getElementById("modalBody").innerText = feature.description;
                    showModal();
                });
            });
        });

        // Filter logic
        const applyFilters = () => {
            const showPublic = document.getElementById("filterPublic").checked;
            const showPrivate = document.getElementById("filterPrivate").checked;
            const showSchongebiet = document.getElementById("filterSchongebiet").checked;

            shapes.forEach(({ shape, public: isPublic, schongebiet }) => {
                if (
                    (isPublic && showPublic) ||
                    (!isPublic && showPrivate) ||
                    (parseInt(schongebiet) === 1 && showSchongebiet)
                ) {
                    shape.setMap(map);
                } else {
                    shape.setMap(null);
                }
            });
        };

        document.getElementById("filterPublic").addEventListener("change", applyFilters);
        document.getElementById("filterPrivate").addEventListener("change", applyFilters);
        document.getElementById("filterSchongebiet").addEventListener("change", applyFilters);
    };

    // Modal logic
    function showModal() {
        const modal = document.getElementById("infoModal");
        modal.style.display = "block";

        document.querySelector(".modal-close").onclick = function () {
            modal.style.display = "none";
        };

        window.onclick = function (event) {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };
    }
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCgBwgs5MqH3y-hhWORHb78miJg0CqBSGw&callback=initMap"></script>

<section class="client_section layout_padding-bottom" style="padding-bottom: 0px;">
    <div class="container">
        <div class="heading_container">
            <h2 id="maps_title">Gewässerkarte</h2>
        </div>
    </div>

    <div id="map" style="height: 75vh; width: 90%; margin: 0 auto; border: 1px solid #ccc;"></div>

    <div id="infoModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div class="modal-header" id="modalTitle"></div>
            <div id="modalBody"></div>
        </div>
    </div>
</section>

<div id="controls">
    <div id="legend">
        <h3 id="legend_title_1" class="legend_title">LEGEND</h3>
        <ul>
            <li><div class="color-box" style="background-color: #0ca4cc;"></div> <neutral_divider id="legend_element_public">Öffentliche Gewässer</neutral_divider></li>
            <li><div class="color-box" style="background-color: #006782;"></div> <neutral_divider id="legend_element_private">Private Gewässer</neutral_divider></li>
            <li><div class="color-box" style="background-color: #94062c;"></div> <neutral_divider id="legend_element_schongebiet">Schongebiete</neutral_divider></li>
        </ul>
    </div>

    <div id="filters">
        <h3 id="filter_title_1" class="legend_title">FILTERS</h3>
        <ul>
            <li><input type="checkbox" id="filterPublic" class="custom-checkbox-1" checked> <neutral_divider id="list_element_filter_public">Öffentliche Gewässer</neutral_divider></li>
            <li><input type="checkbox" id="filterPrivate" class="custom-checkbox-1" checked> <neutral_divider id="list_element_filter_private">Private Gewässer</neutral_divider></li>
            <li><input type="checkbox" id="filterSchongebiet"  class="custom-checkbox-1" checked> <neutral_divider id="list_element_filter_schongebiet">Schongebiete</neutral_divider></li>
        </ul>
    </div>
</div>
{% endblock %}
